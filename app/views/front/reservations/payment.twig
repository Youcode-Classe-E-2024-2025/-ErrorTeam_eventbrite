<!DOCTYPE html>
<html>
<head>
    <title>Paiement</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      .StripeElement {
        background-color: white;
        padding: 16px 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 20px;
      }
    </style>
</head>
<body>
    <h1>Paiement</h1>
    <p>Veuillez confirmer votre paiement pour l'événement: {{ event.getTitle() }}</p>

    <form id="payment-form" action="/events/{{ event.getId() }}/reservations/confirm_payment" method="POST">
        <input type="hidden" name="payment_intent" value="{{ paymentIntent }}">
        <input type="hidden" name="payment_method" id="payment_method" value="">

        <div class="StripeElement" id="card-element">
          <!-- L'élément card de Stripe sera inséré ici. -->
        </div>

        <!-- Messages d'erreur -->
        <div id="card-errors" role="alert"></div>

        <button id="card-button" type="submit" >Confirmer le paiement</button>
    </form>

    <script>
        const stripe = Stripe('pk_test_51QrgWJFaMh57r4UF3WpKVqb7oMv4yZDxn8OU41iNczBVgJmfSHhBFUFwheinRwvZU1ae9b6w9XPEs5bn6s4DVLYB00hCQpJHvc');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        const cardButton = document.getElementById('card-button');
        const paymentForm = document.getElementById('payment-form');
        const cardErrors = document.getElementById('card-errors');

        cardButton.addEventListener('click', async (e) => {
            e.preventDefault();

            const { setupIntent, error } = await stripe.confirmCardSetup('{{ paymentIntent }}', {
                payment_method: {
                  card: cardElement,
                  billing_details: {
                    name: '{{ app.session.user.username }}' // Remplacez par le nom de l'utilisateur si disponible
                  }
                }
              });

            if (error) {
                // Informe l'utilisateur qu'il y a eu une erreur.
                cardErrors.textContent = error.message;
            } else {
                // Envoi du PaymentMethod ID au serveur
                paymentForm.payment_method.value = setupIntent.payment_method;
                paymentForm.submit();
            }
        });
    </script>
</body>
</html>